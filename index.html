<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Answer Script Evaluator â€“ OCR + AI Auto Checker</title>

<!-- PDF.js + Tesseract.js v5 -->
<script src="https://unpkg.com/pdfjs-dist@3.11.174/build/pdf.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js"></script>

<style>
  body { font-family: Arial, sans-serif; background:#eef2f7; margin:0; padding:0; }
  .container { max-width: 900px; margin: auto; padding: 20px; }
  .box { background:#fff; padding:20px; margin-bottom:20px; border-radius:10px; box-shadow:0 0 10px #bbb; }
  h2, h3 { margin-top:0; }
  input, button, select { width:100%; padding:10px; margin:8px 0; font-size:16px; }
  button { cursor:pointer; border:none; background:#2563eb; color:white; border-radius:8px; }
  button:hover { opacity:.9; }
  .result-box { white-space: pre-wrap; background:#f9fafb; padding:10px; border-radius:8px; }
  table { width:100%; border-collapse: collapse; margin-top:10px; }
  th, td { border:1px solid #aaa; padding:8px; text-align:center; }
  .small { font-size:14px; color:#555; }
</style>
</head>

<body>
<div class="container">
<h2>ðŸ“˜ Answer Script Evaluator (OCR + AI Scoring)</h2>

<!-- ANSWER KEY OCR -->
<div class="box">
<h3>1. Upload Answer Key (PDF / DOC / Image)</h3>
<input type="file" id="answerKey" />
<button onclick="runAnswerKeyOCR()">Extract Answer Key (OCR)</button>
<div id="answerKeyText" class="result-box"></div>
</div>

<!-- STUDENT SCRIPT OCR -->
<div class="box">
<h3>2. Upload Student Answer Script (PDF / Image)</h3>
<input type="file" id="studentScript" multiple />
<button onclick="runStudentOCR()">Extract Student Answers (OCR)</button>
<div id="studentText" class="result-box"></div>
</div>

<!-- AI SCORING -->
<div class="box">
<h3>3. AI Scoring</h3>
<button onclick="scoreWithAI()">Score with AI</button>
<div id="aiResult" class="result-box"></div>
</div>

<!-- STUDENT DETAILS -->
<div class="box">
<h3>4. Exam & Student Details</h3>
<input id="examNo" placeholder="Exam No">
<input id="studentName" placeholder="Student Name">
<input id="classSec" placeholder="Class & Section">
<input id="subject" placeholder="Subject">
</div>

<!-- SCORE HANDLING -->
<div class="box">
<h3>5. Score Entry</h3>
<div id="scoreBox" class="result-box"></div>
<button onclick="saveResult()">Save Result</button>
</div>

<!-- RESULTS TABLE -->
<div class="box">
<h3>6. Saved Results</h3>
<table id="resultTable">
<thead><tr><th>Sl.No</th><th>Exam No</th><th>Name</th><th>Score</th></tr></thead>
<tbody></tbody>
</table>
<button onclick="downloadAllPDF()">Download All Results (PDF)</button>
</div>

</div>

<script>
// --------------- CONFIG -----------------
const OPENAI_API_KEY = "Paste your API key";  // <-- Replace this

const { createWorker } = Tesseract;
const pdfjsLib = window['pdfjs-dist/build/pdf'];
pdfjsLib.GlobalWorkerOptions.workerSrc =
  'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';


// --------------- OCR FOR ANSWER KEY -----------------
async function runAnswerKeyOCR(){
    const file = document.getElementById("answerKey").files[0];
    const output = document.getElementById("answerKeyText");

    if(!file){ output.innerText="âš ï¸ Upload answer key first."; return; }

    output.innerText = "ðŸ”„ Running OCR on Answer Key...";

    const worker = await createWorker("eng");

    const imageUrl = await convertToImage(file);
    const result = await worker.recognize(imageUrl);
    output.innerText = result.data.text;

    await worker.terminate();
}


// --------------- OCR FOR STUDENT SCRIPT -----------------
async function runStudentOCR(){
    const files = document.getElementById("studentScript").files;
    const output = document.getElementById("studentText");

    if(files.length===0){ output.innerText="âš ï¸ Upload student script."; return; }

    output.innerText="ðŸ”„ Running OCR on Student Script...";

    const worker = await createWorker("eng");
    let fullText = "";

    for(let i=0;i<files.length;i++){
        const img = await convertToImage(files[i]);
        const result = await worker.recognize(img);
        fullText += result.data.text + "\n\n";
    }

    output.innerText = fullText;
    await worker.terminate();
}


// --------------- PDF/IMAGE TO IMAGE ---------------
async function convertToImage(file){
    if(file.type !== "application/pdf"){
        return URL.createObjectURL(file);
    }

    const pdf = await pdfjsLib.getDocument(URL.createObjectURL(file)).promise;
    const page = await pdf.getPage(1);
    const viewport = page.getViewport({ scale: 2.0 });
    const canvas = document.createElement('canvas');
    const ctx = canvas.getContext('2d');
    canvas.height = viewport.height;
    canvas.width = viewport.width;
    await page.render({ canvasContext: ctx, viewport }).promise;
    return canvas.toDataURL("image/png");
}


// --------------- AI SCORING -----------------
async function scoreWithAI(){
    const answerKey = document.getElementById("answerKeyText").innerText.trim();
    const student = document.getElementById("studentText").innerText.trim();
    const output = document.getElementById("aiResult");
    const finalScore = document.getElementById("scoreBox");

    if(!answerKey || !student){
        output.innerText="âš ï¸ Need both Answer Key and Student Script OCR text.";
        return;
    }

    output.innerText="ðŸ¤– AI evaluating... Please wait...";

    const prompt = `
Compare the STUDENT ANSWER with the OFFICIAL ANSWER KEY.

Return STRICT JSON:
{
  "score": number (0-10),
  "feedback": "short clear feedback"
}

ANSWER KEY:
${answerKey}

STUDENT ANSWER:
${student}
`;

    try{
        const response = await fetch("https://api.openai.com/v1/chat/completions", {
            method:"POST",
            headers:{
                "Content-Type":"application/json",
                "Authorization":"Bearer "+OPENAI_API_KEY
            },
            body:JSON.stringify({
                model:"gpt-4o-mini",
                messages:[
                    {role:"system",content:"You grade answer scripts. Respond only in clean JSON."},
                    {role:"user",content:prompt}
                ]
            })
        });

        const data = await response.json();
        let content = data.choices[0].message.content.trim();

        let json = JSON.parse(content);

        output.innerText = 
          `AI Score: ${json.score}/10\n\nFeedback:\n${json.feedback}`;

        finalScore.innerText = `Total Score: ${json.score}`;

    } catch(e){
        output.innerText = "âŒ AI error: "+e.message;
    }
}


// --------------- SAVE RESULTS -----------------
let resultList = [];

function saveResult(){
    const examNo = document.getElementById("examNo").value.trim();
    const name = document.getElementById("studentName").value.trim();
    const scoreText = document.getElementById("scoreBox").innerText;

    if(!examNo || !name || !scoreText.includes("Total Score")){
        alert("Fill Exam No, Name, and run AI Score first!");
        return;
    }

    const score = scoreText.replace("Total Score: ","");
    resultList.push({examNo, name, score});
    refreshTable();

    document.getElementById("examNo").value="";
    document.getElementById("studentName").value="";
}

function refreshTable(){
    const tbody = document.querySelector("#resultTable tbody");
    tbody.innerHTML="";
    resultList.forEach((r,i)=>{
        tbody.innerHTML+=`
            <tr><td>${i+1}</td><td>${r.examNo}</td><td>${r.name}</td><td>${r.score}</td></tr>
        `;
    });
}


// --------------- DOWNLOAD RESULTS ---------------
function downloadAllPDF(){
    if(resultList.length===0){
        alert("No results recorded.");
        return;
    }
    const w = window.open();
    let html = `<h2>Exam Results</h2>
    <table border="1" style="width:100%; border-collapse:collapse;">
    <tr><th>No</th><th>Exam No</th><th>Name</th><th>Score</th></tr>`;
    resultList.forEach((r,i)=>{
        html+=`<tr><td>${i+1}</td><td>${r.examNo}</td><td>${r.name}</td><td>${r.score}</td></tr>`;
    });
    html+=`</table>`;
    w.document.write(html);
    w.document.close();
    setTimeout(()=>w.print(),400);
}
</script>

</body>
</html>
